- name: Configure EC2 with Docker and pull application
  hosts: app
  become: true
  vars_files:
    - ../.env.example
  vars:
    compose_dir: /home/ubuntu/retrofun_api
    db_container_name: retrofun_api-db-1
    api_container_name: retrofun_api-api-1

  tasks:
    - name: Update apt
      apt:
        update_cache: yes

    - name: Clone app repo
      git:
        repo: https://gitlab.com/joaosr-group/retrofun_api.git
        dest: /home/ubuntu/retrofun_api
        version: main
        force: yes
        accept_hostkey: yes

    - name: Create .env file
      copy:
        dest: /home/ubuntu/retrofun_api/.env
        content: |
          DATABASE_NAME={{ DATABASE_NAME }}
          DATABASE_USERNAME={{ DATABASE_USERNAME }}
          DATABASE_PASSWORD={{ DATABASE_PASSWORD }}
          DATABASE_URL={{ DATABASE_URL }}
          DOCKER_IMAGE={{ DOCKER_IMAGE }}
    
    - name: Copy nginx configuration
      copy:
        src: nginx.conf
        dest: /home/ubuntu/retrofun_api/nginx.conf
        owner: ubuntu
        group: ubuntu
        mode: "0644"

    - name: Ensure docker-compose services are stopped
      shell: docker compose down --remove-orphans || true
      args:
        chdir: "{{ compose_dir }}"
        executable: /bin/bash

    - name: Pull latest images
      shell: docker compose pull
      args:
        chdir: "{{ compose_dir }}"
        executable: /bin/bash

    - name: Start docker-compose services
      shell: docker compose -f compose.yml up -d --remove-orphans
      args:
        chdir: "{{ compose_dir }}"
        executable: /bin/bash

    - name: Wait for Postgres to be healthy
      shell: |
        timeout=30
        until [ "$timeout" -le 0 ]; do
          STATUS=$(docker inspect --format='{{'{{'}}.State.Health.Status{{'}}'}}' {{ db_container_name }} 2>/dev/null || echo "starting")
          echo "⏳ DB status: $STATUS"
          if [ "$STATUS" = "healthy" ]; then
            exit 0
          fi
          sleep 2
          timeout=$((timeout - 2))
        done
        echo "❌ DB did not become healthy"
        exit 1
      register: db_health_check
      failed_when: db_health_check.rc != 0
      changed_when: false
      args:
        chdir: "{{ compose_dir }}"
        executable: /bin/bash

    - name: Run alembic migrations
      shell: docker compose exec -T api alembic upgrade head
      when: db_health_check.rc == 0
      args:
        chdir: "{{ compose_dir }}"
        executable: /bin/bash

    - name: Import products
      shell: docker compose exec -T api python -m retrofun.import_products
      when: db_health_check.rc == 0
      args:
        chdir: "{{ compose_dir }}"
        executable: /bin/bash
      ignore_errors: true

    - name: Import orders
      shell: docker compose exec -T api python -m retrofun.import_orders
      when: db_health_check.rc == 0
      args:
        chdir: "{{ compose_dir }}"
        executable: /bin/bash
      ignore_errors: true
